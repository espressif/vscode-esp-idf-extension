# Using Windows Subsystem for Linux (WSL)

In this tutorial will show you how to develop your projects based on `Visual Studio Code` + `ESP-IDF Extension` + `Remote - WSL` to implement all features of this extension in WSL.

# Required tools

1. WSL 2
2. Ubuntu on Windows using WSL
3. [Visual Studio Code](https://code.visualstudio.com/)
4. [usbipd-win](https://github.com/dorssel/usbipd-win/releases)

## Ubuntu on Windows

If you don't have WSL installed run

```c
wsl --install
```

Update the WSL kernel with

```c
wsl --update
```

Check the WSL available distributions list with the `Powershell` command prompt, as below

```c
wsl -l -o
```

<img src="../../media\tutorials\using_docker_container\wsl-l-o.png" alt="" height="">

so to install WSL on Windows, please type in the following command:

```c
wsl --install --distribution　Ubuntu
```

## usbipd-win

To access the `USB`,`serial`,`JTAG` devices which are from the local Windows, this tools must be installed, else it is impossible to download,monitor and debug on IDF docker image side. the way to install it, it is also same as Windows applications, so it will not be described in detail here.

# Configuration

we still need to do a bit configurations after installing the four tools above:

## Ubuntu on Windows

1. check the current WSL version

   ```c
   wsl -l -v
   ```

   <img src="../../media\tutorials\using_docker_container\wsl-l-v.png" alt="" height="">

1. please upgrade to version 2, if not

   ```c
   wsl --set-version Ubuntu 2
   ```

1. set the distribution as default:
   ```c
   wsl -s Ubuntu
   ```

at last, to check if the commands have taken effect with `wsl --status` command.

<img src="../../media\tutorials\using_docker_container\wsl-status.png" alt="" height="">

## Adding the Required Linux Packages in WSL

Install ESP-IDF requirements for [Linux](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/linux-setup.html#install-prerequisites).

```c
sudo apt-get install git wget flex bison gperf python3-pip python3-venv python3-setuptools cmake ninja-build ccache libffi-dev libssl-dev dfu-util
```

## usbipd

Install usbipd in Powershell command prompt:

```c
winget install usbipd
```

Now configure the USB serial device to be able to connect to the WSL with `usbipd`:

1. <span id="usbipd_instructions"></span>open PowerShell command prompt with administrator rights and then type in the command `usbipd list` for a list of USB serial devices.

2. To access the specified device from Windows on WSL locally, the device must be bound with **usbipd**. Open PowerShell command prompt with administrator rights and then type in the command `usbipd bind --busid <BUSID>`:

   **Note**: this command needs to be used only one time,unless the computer has restarted.

3. after binding, please attach the specified device to WSL with `usbipd attach --wsl --busid <BUSID>` command in the powershell command prompt.s

4. At last, let us check if it works well on both side and type in `dmesg | tail` command on WSL side.

   <img src="../../media\tutorials\using_docker_container\wsl_demsg_tail.png" alt="" height="">

   as we can see above, **1-1** device has been attached to `ttyACM0`, that means WSL can access the **1-1** USB device `<BUSID>` now.

## Visual Studio Code

To develop in WSL, install the `Remote - WSL`、`Remote Development` and `ESP-IDF` extensions, as below:

<img src="../../media\tutorials\using_docker_container\remote_wsl.png" alt="" width="400">

<img src="../../media\tutorials\using_docker_container\esp-idf.png" alt="" width="400">

# **Configure the ESP-IDF extension as explained in the [Install](./tutorial/install.md) tutorial or in [Setup](./SETUP.md) documentation.**

   > **NOTE:** Running the setup from WSL could override the Windows host machine configuration settings since it is using the User Settings by default. Consider saving settings to a workspace or workspace folder as described in the [working with multiple projects document](../MULTI_PROJECTS.md).

# Practice

After all previous steps have taken effect, the WSL should be ready to use. Here is an example to show you how to utilize these tools.

## Example Project with WSL

Using `blink` and `hello_world` projects as examples:

<img src="../../media\tutorials\using_docker_container\example_projects.png" alt="" height="">

as seen from snapshot above, `blink` and `hello_world` example projects have been put in the same folder and we only need to open this folder with vscode:

<img src="../../media\tutorials\using_docker_container\example_project_vscode.gif" alt="" height="">

some readers may see that there is a `.devcontainer` folder in the example_project folder, which is not included by default; this is generated by using the ESP-IDF extension of Visual Studio Code to create and configure the IDF docker image for container development. Check the [docker container tutorial](./using-docker-container.md) for more information.

## Open Project in WSL

Start your development by clicking the `><` green button at the left bottom of Visual Studio Code and select `Open Folder in WSL` to start configuring the WSL and open the `Blink` example project.

at this moment, you can start to use the `Blink` example project for building, flashing, monitoring, debugging, etc.

## Building the Project

Here taking the esp32-c3 as an example, users only need to change the target device from `esp32` to `esp32-c3`, as below:

<img src="../../media\tutorials\using_docker_container\device_target_esp32_c3.png" alt="" height="">

next, start to build the example project, as below:

<img src="../../media\tutorials\using_docker_container\container_build.gif" alt="" height="">

## Flashing to your Device

after building, we can use the following ways to download the firmware.

### External USB-Serial

Based on the description above, users can follow the instructions [usbipd](#usbipd_instructions) section mentioned. here `Silicon Labs CP210x USB to UART Bridge` is taken as an example, it has been attached to docker image:

<img src="../../media\tutorials\using_docker_container\wsl_demsg_tail_usb_serial.png" alt="" height="">

as you can see, this device has attached to `ttyUSB0`, so `idf.port` also need to change accordingly.

<img src="../../media\tutorials\using_docker_container\ttyUSB0.png" alt="" height="">

but, the container doesn't know the configuration has changed yet at this moment.

<img src="../../media\tutorials\using_docker_container\unkown_ttyUSB0.png" alt="" height="">

so users need to reopen the container, that is `Reopen Folder Locally` and then the new configuration wil be reloaded as well.

<img src="../../media\tutorials\using_docker_container\container_reopen.gif" alt="" height="">

at last, click the `flash` button and start to download the firmware.

<img src="../../media\tutorials\using_docker_container\container_flash_uart.gif" alt="" height="">

### Internal USB-serial

Just as the external usb-serial, the only difference is the number attached. where the external usb-serial is `ttyUSBx`, while the internal usb-serial is `ttyACMx`.

<img src="../../media\tutorials\using_docker_container\container_flash_uart_internal.gif" alt="" height="">

### USB-JTAG

Same as [External USB-Serial](#external-usb-serial) and [Internal USB-serial](#internal-usb-serial), but it needs to configure the following extra parameters:

<img src="../../media\tutorials\using_docker_container\extra_parameters.png" alt="" height="">

the interface is the same as [Internal USB-serial](#internal-usb-serial), that is `ttyACMx`:

<img src="../../media\tutorials\using_docker_container\container_flash_jtag.gif" alt="" height="">

### Additional steps for debugging

Make sure to run `ESP-IDF: Add OpenOCD rules file (For Linux users)` command to add OpenOCD rules in the WSL before running OpenOCD and starting a debug session.

## Debugging

After following [USB-JTAG](#usb-jtag), press `F5` to start to debug:

<img src="../../media\tutorials\using_docker_container\container_debug.gif" alt="" height="">

# Precautions

1. If you want to debug on Windows, you need to unplug the USB cable and re-plug in it again, otherwise the corresponding USB port cannot be found in the Windows device manager.
