name: CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  extension_ci:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: "recursive"

      - name: Install ESP-IDF
        run: |
          ESP_IDF_VERSION="v5.3.2"
          sudo apt update
          sudo apt install -y python3-pip git wget flex bison gperf python3-venv cmake ninja-build ccache libffi-dev libssl-dev dfu-util
          wget https://dl.espressif.com/github_assets/espressif/esp-idf/releases/download/${ESP_IDF_VERSION}/esp-idf-${ESP_IDF_VERSION}.zip -O esp-idf.zip
          unzip esp-idf.zip -d ~/
          rm esp-idf.zip
          mv ~/esp-idf-${ESP_IDF_VERSION} ~/esp-idf
          ~/esp-idf/install.sh

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Yarn dependencies
        run: |
          yarn
          yarn install

      - name: Run Yarn script with xvfb
        run: |
          source ~/esp-idf/export.sh
          export GIT_VERSION=$(git --version | sed -nre 's/^[^0-9]*(([0-9]+\.)*[0-9]+).*/\1/p')
          export IDF_VERSION=$(idf.py --version | sed -nre 's/^[^0-9]*(([0-9]+\.)*[0-9]+).*/\1/p')
          export PY_VERSION=$(python --version | sed -nre 's/^[^0-9]*(([0-9]+\.)*[0-9]+).*/\1/p')
          export PIP_VERSION=$(python -m pip --version | sed -nre 's/^[^0-9]*(([0-9]+\.)*[0-9]+).*/\1/p')
          export PY_PKGS=$(python -m pip list --format json)
          xvfb-run --auto-servernum yarn test

      - name: Print Test Results to Console
        run: |
          echo "=== Test Results Summary ==="
          if [ -f "./out/results/test-results.json" ]; then
            echo "Total tests: $(jq '.stats.tests' ./out/results/test-results.json)"
            echo "Passed: $(jq '.stats.passes' ./out/results/test-results.json)"
            echo "Failed: $(jq '.stats.failures' ./out/results/test-results.json)"
            echo "Pending: $(jq '.stats.pending' ./out/results/test-results.json)"
            echo ""
            echo "=== Failed Tests ==="
            jq -r '.failures[]? | "❌ \(.title): \(.err.message)"' ./out/results/test-results.json || echo "No failed tests"
            echo ""
            echo "=== All Test Results ==="
            jq -r '.tests[]? | "\(if .state == "passed" then "✅" else "❌" end) \(.title)"' ./out/results/test-results.json || echo "No test results found"
          else
            echo "Test results file not found"
          fi

      - name: Publish Test Report
        uses: dorny/test-reporter@v2
        if: always()
        with:
          name: Mocha Tests
          path: ./out/results/test-results.json
          reporter: mocha-json

      - name: Upload if failed test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-result.json
          path: ./out/results/test-results.json

      - name: Package .vsix
        run: yarn package

      - name: Upload .vsix File
        uses: actions/upload-artifact@v4
        with:
          name: esp-idf-extension.vsix
          path: esp-idf-extension.vsix
